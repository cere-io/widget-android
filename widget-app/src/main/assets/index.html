<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="theme-color" content="#000000">
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width shrink-to-fit=no">

    <style>
        html, body, #root {
            min-height: 100% !important;
            height: 100%;
            width: 100%
        }
    </style>

    <script type="text/javascript">
      window.widget = {
        userId: '::userId::',
        appId: '::appId::',
        env: '::env::',
        mode: '::mode::',
        sections: '::sections::'.split(',')
      };

      console.log('Widget data', window.widget);

      var script = document.createElement('script');
      script.src = '::widgetUrl::';
      script.defer = true;
      script.onload = function() {

        function processPromise(data) {
          var res = null;

          if (data) {
            try {
              res = JSON.parse(data);
            } catch (e) {
              res = data;
            }
          }

          console.log('WidgetAndroidSDK::result', res);
          return res;
        }

        var t = setInterval(function() {

          console.log('Check JS Bridge', window.WebViewJavascriptBridge);
          var nativeStorage = window.NativeStorage;
          console.log('Check NativeStorage', nativeStorage);

          if (window.WebViewJavascriptBridge && nativeStorage) {
            clearInterval(t);
            t = null;

            var jsBridge = window.WebViewJavascriptBridge;

            console.log(jsBridge);

            window.CRBWidget.init({
              uid: window.widget.userId,
              appId: window.widget.appId,
              env: window.widget.env,
              sections: window.widget.sections,
              mode: window.widget.mode,
              setStorageItem: function (key, value) {
                return nativeStorage.setItem(key, value)
                  .then(processPromise);
              },
              getStorageItem: function (key) {
                return nativeStorage.getItem(key)
                  .then(processPromise);
              }
            });

            window.CRBWidget.onInitialized(function() {
              console.log('===>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> Widget Initialized');
              jsBridge.callHandler('initialized', {}, function(response) {});
            });

            jsBridge.registerHandler('logout', function(data, callback) {
              window.CRBWidget.logout()
                .then(callback);
            });
          }
        }, 1000);
      };

      var firstScript = document.getElementsByTagName('script')[0];
      firstScript.parentNode.insertBefore(script, firstScript);
    </script>
</head>
<body>
</body>
</html>